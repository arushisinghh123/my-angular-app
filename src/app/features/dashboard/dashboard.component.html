<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">Sequence Analysis Dashboard</h1>
  </div>

  <!-- Top Filters Section -->
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-group">
        <label class="filter-label">Scenario:</label>
        <mat-form-field appearance="outline" class="scenario-field">
          <mat-select 
            [formControl]="scenarioControl"
            placeholder="Select scenario">
            <mat-option 
              *ngFor="let scenario of scenarios" 
              [value]="scenario">
              {{ scenario.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filter-group">
        <label class="filter-label">Sequence:</label>
        <mat-form-field appearance="outline" class="sequence-field">
          <input 
            matInput 
            [formControl]="sequenceFilterControl"
            placeholder="Enter sequence name"
            [matAutocomplete]="sequenceAuto">
          <mat-autocomplete 
            #sequenceAuto="matAutocomplete"
            [displayWith]="displaySequenceName">
            <mat-option 
              *ngFor="let sequence of filteredSequenceOptions | async" 
              [value]="sequence">
              {{ sequence.name }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>

      <div class="filter-group">
        <mat-form-field appearance="outline" class="frame-field">
          <input 
            matInput 
            type="number"
            [formControl]="frameControl"
            placeholder="Frame #"
            [disabled]="!selectedSequenceFromInput">
        </mat-form-field>
        <button 
          mat-raised-button 
          color="primary" 
          class="go-button"
          (click)="goToFrame()"
          [disabled]="!canGoToFrame()">
          GO
        </button>
      </div>
    </div>

    <div class="radio-group">
      <mat-radio-group 
        [formControl]="viewModeControl"
        class="view-mode-group">
        <mat-radio-button value="all" class="radio-option">
          View all
        </mat-radio-button>
        <mat-radio-button value="present" class="radio-option">
          Show only sequences where present
        </mat-radio-button>
      </mat-radio-group>
    </div>
  </div>

  <!-- Main Content - Two Column Layout -->
  <div class="main-content" *ngIf="selectedScenario">
    <!-- Left Column - Sequence Visualization -->
    <div class="left-column">
      <!-- Sequence Bars Section -->
      <div class="sequences-section">
        <h2 class="section-title">{{ selectedScenario.name }} Presence Across Sequences:</h2>
        
        <div class="sequences-container">
          <div class="sequences-list-wrapper">
            <div class="sequences-list" #sequencesList>
              <div 
                *ngFor="let sequence of filteredSequences; let i = index"
                class="sequence-row">
                <div class="sequence-header">
                  <span class="sequence-label">Sequence {{ i + 1 }}:</span>
                </div>
                
                <div class="sequence-bar-container">
                  <div class="sequence-bar" [style.width.px]="sequenceBarWidth">
                    <div 
                      *ngFor="let segment of getSequenceSegments(sequence); trackBy: trackBySegment"
                      class="bar-segment"
                      [class.tunnel-present]="segment.hasScenario"
                      [class.no-tunnel]="!segment.hasScenario"
                      [style.width.%]="segment.width"
                      [matTooltip]="getSegmentTooltip(segment, sequence)"
                      matTooltipPosition="above"
                      (click)="onSegmentClick(sequence, segment)">
                    </div>
                  </div>
                  
                  <div class="sequence-controls">
                    <button 
                      mat-icon-button 
                      class="control-btn zoom-btn"
                      (click)="zoomSequence(sequence.id)"
                      matTooltip="Zoom">
                      <mat-icon>search</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      class="control-btn nav-btn"
                      (click)="scrollSequenceLeft(sequence.id)"
                      matTooltip="Scroll Left">
                      <mat-icon>keyboard_arrow_left</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      class="control-btn nav-btn"
                      (click)="scrollSequenceRight(sequence.id)"
                      matTooltip="Scroll Right">
                      <mat-icon>keyboard_arrow_right</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Legend -->
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color no-tunnel"></div>
            <span>No {{ selectedScenario.name.toLowerCase() }}</span>
          </div>
          <div class="legend-item">
            <div class="legend-color tunnel-present"></div>
            <span>{{ selectedScenario.name }} present</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Frame Details -->
    <div class="right-column">
      <!-- Frame Image Viewer -->
      <div class="frame-viewer-section">
        <h3 class="section-subtitle">Frame Image Viewer</h3>
        
        <div class="frame-display">
          <div class="image-container" *ngIf="currentFrameData; else noFrameSelected">
            <img 
              [src]="currentFrameData.imagePath" 
              [alt]="'Frame ' + currentFrameData.frameNumber"
              class="frame-image"
              (load)="onImageLoad()"
              (error)="onImageError()">
            
            <div class="loading-overlay" *ngIf="imageLoading">
              <mat-spinner diameter="40"></mat-spinner>
            </div>
          </div>
          
          <ng-template #noFrameSelected>
            <div class="no-frame-placeholder">
              <mat-icon class="placeholder-icon">photo</mat-icon>
              <p>Select a frame to view</p>
            </div>
          </ng-template>

          <div class="frame-info" *ngIf="currentFrameData && selectedSequence">
            <div class="info-row">
              <span class="info-label">Sequence:</span>
              <span class="info-value">{{ selectedSequence.name }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Frame:</span>
              <span class="info-value">{{ currentFrameData.frameNumber }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">{{ selectedScenario.name }}:</span>
              <span 
                class="info-value scenario-status"
                [class.present]="currentFrameData.scenarioPresence"
                [class.absent]="!currentFrameData.scenarioPresence">
                {{ currentFrameData.scenarioPresence ? 'Yes' : 'No' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Frame Navigation -->
      <div class="frame-navigation-section">
        <h3 class="section-subtitle">Frame Navigation</h3>
        
        <div class="navigation-controls">
          <div class="nav-buttons">
            <button 
              mat-stroked-button 
              class="nav-btn"
              (click)="navigateFrame(-100)"
              [disabled]="!canNavigate(-100)">
              -100
            </button>
            <button 
              mat-stroked-button 
              class="nav-btn"
              (click)="navigateFrame(-10)"
              [disabled]="!canNavigate(-10)">
              -10
            </button>
            <button 
              mat-stroked-button 
              class="nav-btn"
              (click)="navigateFrame(-1)"
              [disabled]="!canNavigate(-1)">
              -1
            </button>
            <button 
              mat-stroked-button 
              class="nav-btn"
              (click)="navigateFrame(1)"
              [disabled]="!canNavigate(1)">
              +1
            </button>
            <button 
              mat-stroked-button 
              class="nav-btn"
              (click)="navigateFrame(10)"
              [disabled]="!canNavigate(10)">
              +10
            </button>
            <button 
              mat-stroked-button 
              class="nav-btn"
              (click)="navigateFrame(100)"
              [disabled]="!canNavigate(100)">
              +100
            </button>
          </div>

          <button 
            mat-raised-button 
            color="primary"
            class="play-button"
            (click)="playSequence()"
            [disabled]="!selectedSequence">
            <mat-icon>play_arrow</mat-icon>
            Play entire sequence
          </button>

          <div class="frame-counter" *ngIf="selectedSequence">
            <span>Frame: {{ currentFrame || 1 }} of {{ selectedSequence.totalFrames || 5678 }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Section - Summary (Full Width) -->
  <div class="summary-section-full" *ngIf="selectedScenario && filteredSequences.length > 0">
    <h2 class="section-title">{{ selectedScenario.name }} Presence Summary (%):</h2>
    
    <div class="summary-bars">
      <div 
        *ngFor="let sequence of filteredSequences; let i = index"
        class="summary-row">
        <span class="summary-label">Sequence {{ i + 1 }}:</span>
        <div class="summary-bar-container">
          <div 
            class="summary-bar"
            [style.width.%]="getSequencePercentage(sequence)">
          </div>
          <span class="percentage-label">{{ getSequencePercentage(sequence) }}%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- No Scenario Selected State -->
  <div class="no-scenario-state" *ngIf="!selectedScenario">
    <mat-icon class="no-data-icon">folder</mat-icon>
    <p>Please select a scenario to begin analysis</p>
  </div>
</div>

<!-- Image Popup -->
<app-image-popup
  *ngIf="showImagePopup"
  [imagePath]="popupImageData.imagePath"
  [frameNumber]="popupImageData.frameNumber"
  [sequenceName]="popupImageData.sequenceName"
  [scenarioName]="popupImageData.scenarioName"
  [scenarioPresence]="popupImageData.scenarioPresence"
  (closePopup)="closeImagePopup()">
</app-image-popup>